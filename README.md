# IPTV ç»„æ’­æµåª’ä½“è´¨é‡å®æ—¶ç›‘æµ‹ç³»ç»Ÿ

ä¸€ä¸ªå®Œæ•´çš„300è·¯ç»„æ’­æµåª’ä½“è´¨é‡å®æ—¶ç›‘æµ‹ç³»ç»Ÿï¼Œæ”¯æŒï¼š

- **Pythonæ¢é’ˆå±‚**ï¼š300è·¯å¹¶å‘ UDP ç»„æ’­æ¥æ”¶ï¼ŒMPEG-TS è§£æï¼ˆPAT/PMT/SDT/EITï¼‰ï¼Œé»‘å±/å†»å±/é™éŸ³/çˆ†éŸ³/ä¸¢åŒ…/CCé”™è¯¯/PCRæŠ–åŠ¨/ç ç‡å¼‚å¸¸æ£€æµ‹
- **å­˜å‚¨å±‚**ï¼šInfluxDBï¼ˆæ—¶åºæŒ‡æ ‡ï¼‰+ SQLiteï¼ˆé¢‘é“é…ç½®/å‘Šè­¦å†å²ï¼‰+ Redisï¼ˆå®æ—¶çŠ¶æ€ç¼“å­˜ï¼‰
- **FastAPI åç«¯**ï¼šREST API + WebSocket å®æ—¶æ¨é€
- **Vue3 Web å¤§å±**ï¼šECharts å®æ—¶å›¾è¡¨ï¼Œ300è·¯èŠ‚ç›®4è‰²äº¤é€šç¯çŠ¶æ€
- **éŸ³é¢‘å‘Šè­¦**ï¼šWeb Speech API TTS è¯­éŸ³æ’­æŠ¥ï¼Œ5åˆ†é’ŸæŠ‘åˆ¶ + å¤šè·¯èšåˆ
- **ç¼©ç•¥å›¾**ï¼šæ¯5ç§’æˆªå–ï¼Œå‘Šè­¦æ—¶åˆ»æˆªå›¾æ°¸ä¹…ä¿ç•™
- **ä»¿çœŸæ¨¡å¼**ï¼šæœ¬åœ°è§†é¢‘æ–‡ä»¶æ¨¡æ‹Ÿç»„æ’­æºï¼Œå¯æ‰‹åŠ¨è§¦å‘å„ç±»æ•…éšœ
- **Docker Compose**ï¼šä¸€é”®éƒ¨ç½²æ‰€æœ‰æœåŠ¡

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UDP ç»„æ’­æº (239.1.1.1 ~ 239.1.2.44, port 1234)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Probe æœåŠ¡ (10è¿›ç¨‹)   â”‚
         â”‚  æ¯è¿›ç¨‹ 30è·¯ asyncio  â”‚
         â”‚  TSè§£æ/è§†é¢‘/éŸ³é¢‘åˆ†æ  â”‚
         â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚          â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
     â”‚InfluxDB â”‚  â”‚  Redis   â”‚
     â”‚æ—¶åºæ•°æ®  â”‚  â”‚å®æ—¶çŠ¶æ€   â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
            â”‚         â”‚ Pub/Sub
         â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
         â”‚  FastAPI åç«¯    â”‚
         â”‚  REST API       â”‚
         â”‚  WebSocket      â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Vue3 å‰ç«¯å¤§å±   â”‚
         â”‚  EChartså›¾è¡¨     â”‚
         â”‚  TTSè¯­éŸ³å‘Šè­¦     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ–æ•°æ®åº“ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰

```bash
mkdir -p data/db data/thumbnails data/videos
python3 scripts/init_db.py
```

### 2. å‡†å¤‡ä»¿çœŸæµ‹è¯•è§†é¢‘ï¼ˆå¯é€‰ï¼‰

```bash
# ä½¿ç”¨ ffmpeg ç”Ÿæˆæµ‹è¯•è§†é¢‘
ffmpeg -f lavfi -i testsrc=duration=600:size=1280x720:rate=25 \
       -f lavfi -i sine=frequency=1000:duration=600 \
       -c:v libx264 -crf 23 -c:a aac \
       data/videos/testsrc.mp4
```

### 3. å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
docker compose up -d
```

æœåŠ¡å¯åŠ¨åï¼š
- **å¤§å±å‰ç«¯**ï¼šhttp://localhost
- **API æ¥å£**ï¼šhttp://localhost:8000
- **API æ–‡æ¡£**ï¼šhttp://localhost:8000/docs
- **InfluxDB**ï¼šhttp://localhost:8086

### 4. éªŒè¯è¿è¡ŒçŠ¶æ€

```bash
docker compose ps
curl http://localhost:8000/health
curl http://localhost:8000/api/v1/channels | jq '.[0]'
```

## å‘Šè­¦çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | é¢œè‰² | è§¦å‘æ¡ä»¶ |
|------|------|---------|
| æ­£å¸¸ (NORMAL) | ğŸŸ¢ ç»¿è‰² | æ‰€æœ‰æŒ‡æ ‡æ­£å¸¸ |
| æ³¨æ„ (WARNING) | ğŸŸ¡ é»„è‰² | CCé”™è¯¯>5/sã€PCRæŠ–åŠ¨>40msã€ç ç‡åå·®>30% |
| å‘Šè­¦ (ALARM) | ğŸ”´ çº¢è‰²ï¼ˆé—ªçƒï¼‰ | é»‘å±/å†»å±/é™éŸ³ |
| ç¦»çº¿ (OFFLINE) | âš« ç°è‰² | 2ç§’æ— UDPæ•°æ® |

## ä»¿çœŸæ•…éšœæ³¨å…¥

é€šè¿‡ API è§¦å‘ï¼š

```bash
# è§¦å‘ ch001 é»‘å± 30ç§’
curl -X POST http://localhost:8000/api/v1/sim/trigger \
  -H 'Content-Type: application/json' \
  -d '{"channel_id": "ch001", "fault_type": "BLACK_SCREEN", "duration_sec": 30}'

# æ¸…é™¤æ•…éšœ
curl -X POST http://localhost:8000/api/v1/sim/clear \
  -d '{"channel_id": "ch001"}'
```

æ”¯æŒçš„æ•…éšœç±»å‹ï¼š`BLACK_SCREEN` / `FROZEN` / `SILENT` / `PACKET_LOSS` / `BITRATE_DROP`

ä¹Ÿå¯ä»¥é€šè¿‡å¤§å±å‰ç«¯çš„"ä»¿çœŸæµ‹è¯•"é¡µé¢æ“ä½œã€‚

## API æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/v1/channels` | è·å–æ‰€æœ‰é¢‘é“å½“å‰çŠ¶æ€ |
| GET | `/api/v1/channels/{id}` | è·å–å•è·¯é¢‘é“çŠ¶æ€ |
| GET | `/api/v1/channels/{id}/metrics?range=5m` | è·å–å†å²æŒ‡æ ‡ï¼ˆInfluxDBï¼‰ |
| GET | `/api/v1/channels/stats/overview` | ç»Ÿè®¡æ±‡æ€» |
| GET | `/api/v1/alerts` | è·å–å‘Šè­¦åˆ—è¡¨ |
| POST | `/api/v1/alerts/{id}/ack` | å‘Šè­¦ç¡®è®¤ |
| GET | `/api/v1/thumbnails/{id}/latest` | æœ€æ–°ç¼©ç•¥å›¾ |
| GET | `/api/v1/thumbnails/{id}/alarms` | å‘Šè­¦æˆªå›¾åˆ—è¡¨ |
| WS | `/ws/realtime` | å®æ—¶æ¨é€ WebSocket |

## ç»„æ’­ç½‘ç»œé…ç½®

æ¢é’ˆæœåŠ¡ä½¿ç”¨ `network_mode: host`ï¼ˆå®¹å™¨ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œï¼‰ï¼Œéœ€è¦å®¿ä¸»æœºæ”¯æŒ IP ç»„æ’­ï¼š

```bash
# ç¡®è®¤å®¿ä¸»æœºç»„æ’­è·¯ç”±
ip route show 224.0.0.0/4
# è‹¥æœªé…ç½®ï¼Œæ·»åŠ è·¯ç”±
ip route add 224.0.0.0/4 dev eth0

# é˜²ç«å¢™å¼€æ”¾ UDP 1234
iptables -I INPUT -p udp --dport 1234 -j ACCEPT
```

## ç›®å½•ç»“æ„

```
iptv-monitor/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env
â”œâ”€â”€ probe/                # Pythonæ¢é’ˆæœåŠ¡
â”‚   â”œâ”€â”€ main.py           # å…¥å£ï¼š10ä¸ªWorkerè¿›ç¨‹
â”‚   â”œâ”€â”€ worker.py         # Workerï¼š30è·¯asyncioåç¨‹
â”‚   â”œâ”€â”€ ts_parser.py      # TSåŒ…è§£æï¼ˆPAT/PMT/SDT/EIT/CC/PCRï¼‰
â”‚   â”œâ”€â”€ status_machine.py # 4çº§çŠ¶æ€åˆ¤å®š
â”‚   â”œâ”€â”€ simulator.py      # ä»¿çœŸæ¨¡å¼
â”‚   â”œâ”€â”€ analyzers/        # è§†é¢‘/éŸ³é¢‘/ç ç‡/PCRåˆ†æå™¨
â”‚   â””â”€â”€ storage/          # InfluxDB/Redis/SQLiteå†™å…¥å™¨
â”œâ”€â”€ api/                  # FastAPIåç«¯
â”‚   â”œâ”€â”€ main.py
â”‚   â”œâ”€â”€ routers/          # REST APIè·¯ç”±
â”‚   â”œâ”€â”€ websocket/        # WebSocketç®¡ç†å™¨
â”‚   â”œâ”€â”€ models/           # Pydanticæ¨¡å‹
â”‚   â””â”€â”€ db/               # InfluxDB/Redis/SQLiteå®¢æˆ·ç«¯
â”œâ”€â”€ frontend/             # Vue3å¤§å±å‰ç«¯
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ components/   # ChannelGrid/Card/Chart/Alertç»„ä»¶
â”‚       â”œâ”€â”€ stores/       # PiniaçŠ¶æ€ç®¡ç†
â”‚       â””â”€â”€ composables/  # WebSocket/å‘Šè­¦æŠ‘åˆ¶
â”œâ”€â”€ scripts/
â”‚   â””â”€â”€ init_db.py        # æ•°æ®åº“åˆå§‹åŒ–+300è·¯é…ç½®
â””â”€â”€ data/
    â”œâ”€â”€ db/               # SQLiteæ•°æ®åº“
    â”œâ”€â”€ thumbnails/       # ç¼©ç•¥å›¾æ–‡ä»¶
    â””â”€â”€ videos/           # ä»¿çœŸæµ‹è¯•è§†é¢‘
```

## æ€§èƒ½è¯´æ˜

- **æ¢é’ˆè¿›ç¨‹**ï¼š10ä¸ª multiprocessing.Processï¼Œæ¯è¿›ç¨‹å¤„ç†30è·¯ï¼Œæ¯è¿›ç¨‹4ä¸ªå¸§åˆ†æçº¿ç¨‹
- **è§†é¢‘åˆ†æ**ï¼šæ¯5ç§’é‡‡æ ·1å¸§ï¼ˆå¯é…ç½® `FRAME_SAMPLE_INTERVAL_SEC`ï¼‰
- **æŒ‡æ ‡å†™å…¥**ï¼šæ¯ç§’æ‰¹é‡å†™å…¥ InfluxDBï¼ˆæœ€å¤š300 Points/æ‰¹ï¼‰
- **RedisçŠ¶æ€**ï¼šæ¯ç§’æ›´æ–°ï¼ŒTTL=30ç§’ï¼ˆè¶…æ—¶è‡ªåŠ¨æ ‡è®°ä¸ºç¦»çº¿ï¼‰
- **WebSocket**ï¼šRedis Pub/Sub è½¬å‘ï¼Œæ”¯æŒå¤šå®¢æˆ·ç«¯åŒæ—¶è¿æ¥
